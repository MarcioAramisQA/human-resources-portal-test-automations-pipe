name: Porta RH Test E2E

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

    
jobs:
  test:
    name: Porta RH Test E2E
    timeout-minutes: 60
    runs-on: ubuntu-latest
    test:
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Cache node modules
        uses: actions/cache@v4
        with:
        path: ~/.npm # Cache a pasta de cache do npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

      - name: Install dependencies
        if: always()
        run: |
          npm install

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
        path: ~/.cache/ms-playwright # Cache a pasta onde o Playwright instala os navegadores
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

      - name: Install Browsers
        if: always()
        run: |
          npx playwright install

      - name: Run E2E tests
        run: |
          npx playwright test
        env:
          CONNECT_MGR: ${{ secrets.CONNECT_MGR }}
          CONNECT_HRA: ${{ secrets.CONNECT_HRA }}
          CONNECT_PASSWORD: ${{ secrets.CONNECT_PASSWORD }}
          CONNECT_URL: ${{ secrets.CONNECT_URL }}
        
      - name: Publish Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Fail on flaky tests
        if: ${{ steps.run_tests.outcome == 'success' }}
        run: |
          if jq -e '[.suites[] | (.tests // [])[] | select((.results // [] | length) > 1)] | length > 0' test-results.json > /dev/null; then
            echo "::error::Testes inst√°veis detectados (flaky)."
            exit 1
          fi
